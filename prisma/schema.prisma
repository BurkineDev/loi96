// ===========================================
// Schéma Prisma pour ConformLoi96
// ===========================================
// Base de données PostgreSQL via Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===========================================
// Modèle Utilisateur (synchronisé avec Clerk)
// ===========================================
model User {
  id            String    @id // Clerk User ID (user_xxx)
  email         String    @unique
  firstName     String?
  lastName      String?
  imageUrl      String?

  // Abonnement Paddle
  plan                    Plan      @default(FREE)
  paddleCustomerId        String?   @unique  // ctm_xxx
  paddleSubscriptionId    String?   @unique  // sub_xxx
  subscriptionStatus      SubscriptionStatus @default(FREE)
  currentPeriodStart      DateTime?
  currentPeriodEnd        DateTime?
  trialEndsAt             DateTime? // Fin de la période d'essai 14 jours

  // Compteurs (5 checks gratuits par mois)
  checksUsed          Int      @default(0)
  checksResetDate     DateTime @default(now()) // Date de reset des checks mensuels

  // Relations
  documents     Document[]
  analyses      Analysis[]

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([paddleCustomerId])
}

// ===========================================
// Plans d'abonnement
// ===========================================
enum Plan {
  FREE      // 5 vérifications/mois gratuites
  STARTER   // 19$/mois - vérifications illimitées
  PRO       // 49$/mois - illimité + support prioritaire + exports avancés
}

// ===========================================
// Statut d'abonnement
// ===========================================
enum SubscriptionStatus {
  FREE        // Plan gratuit
  TRIALING    // Période d'essai 14 jours
  ACTIVE      // Abonnement actif
  PAST_DUE    // Paiement en retard
  PAUSED      // Abonnement en pause
  CANCELED    // Abonnement annulé
}

// ===========================================
// Modèle Document
// ===========================================
model Document {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Métadonnées du document
  name          String
  type          DocumentType
  originalText  String    @db.Text
  fileUrl       String?   // URL Supabase Storage si fichier uploadé
  mimeType      String?
  fileSize      Int?
  
  // Relations
  analyses      Analysis[]
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([userId])
  @@index([createdAt])
}

// ===========================================
// Types de documents
// ===========================================
enum DocumentType {
  PDF           // Document PDF
  WORD          // Document Word
  TEXT          // Fichier texte
  PASTE         // Texte collé
  INVOICE       // Facture
  CONTRACT      // Contrat
  WEBSITE_TEXT  // Texte de site web
  MARKETING     // Document marketing
  LEGAL         // Document légal
  OTHER         // Autre
}

// ===========================================
// Modèle Analyse
// ===========================================
model Analysis {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentId    String
  document      Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Résultats de l'analyse
  isCompliant       Boolean   @default(false)
  complianceScore   Int       @default(0)  // Score 0-100
  
  // Détections de langue
  detectedLanguage  String?   // "french" | "english" | "bilingual" | "other"
  frenchPercentage  Float?    // 0-100
  
  // Problèmes détectés (JSON array)
  issues        String?   @db.Text  // JSON stringifié
  
  // Suggestions de corrections
  suggestions   String?   @db.Text  // JSON stringifié
  
  // Texte corrigé
  correctedText String?   @db.Text
  correctedPdfUrl String? // URL du PDF corrigé
  
  // Métadonnées
  processingTime Int?     // En millisecondes
  aiModel       String?   // Modèle Claude utilisé
  
  // Timestamps
  createdAt     DateTime  @default(now())
  completedAt   DateTime?
  
  @@index([userId])
  @@index([documentId])
  @@index([createdAt])
}

// ===========================================
// Modèle pour les webhooks Paddle
// ===========================================
model WebhookEvent {
  id            String    @id @default(cuid())
  eventId       String    @unique  // Paddle event ID
  eventType     String              // subscription.created, subscription.updated, etc.
  data          Json                // Payload complet du webhook
  processed     Boolean   @default(false)
  processedAt   DateTime?
  error         String?   @db.Text  // Erreur de traitement si applicable

  createdAt     DateTime  @default(now())

  @@index([eventId])
  @@index([eventType])
  @@index([processed])
}

// ===========================================
// Audit des analyses (rate limiting)
// ===========================================
model AnalysisAudit {
  id            String    @id @default(cuid())
  userId        String
  ipAddress     String?
  userAgent     String?
  success       Boolean
  errorMessage  String?

  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([ipAddress])
}
